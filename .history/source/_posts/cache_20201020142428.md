---
title: 跟我一起学习缓存吧
date: 2020-10-14 18:51:13
categories: 网络基础
tags: 缓存 cache
---

### 序

尝试用新的学习方法，学习缓存。
一直对缓存的了解都比较少，开始学习

## 前端缓存

通过缓存可以让性能——将相应数据存储起来以避免数据的重复创建、处理和传输，可有效提高性能。比如将不改变的数据缓存起来，例如国家列表等，这样能明显提高 web 程序的反应速度；

· 稳定性——同一个应用中，对同一数据、逻辑功能和用户界面的多次请求时经常发生的。当用户基数很大时，如果每次请求都进行处理，消耗的资源是很大的浪费，也同时造成系统的不稳定。例如，web 应用中，对一些静态页面的呈现内容进行缓存能有效的节省资源，提高稳定性。而缓存数据也能降低对数据库的访问次数，降低数据库的负担和提高数据库的服务能力；

· 可用性——有时，提供数据信息的服务可能会意外停止，如果使用了缓存技术，可以在一定时间内仍正常提供对最终用户的支持，提高了系统的可用性。

·减少交互的通讯量——缓存数据能有效减少在进程和机器间的传输量；

·降低系统中的处理量——减少处理次数；

·降低需要做的磁盘访问次数——比如缓存在内存中的数据。

### HTTP 缓存

#### 强缓存

##### Expires

- 值为服务端返回的到期时间，即下一次请求时，请求时间小于服务端返回的到期时间，直接使用缓存数据；
- 到期时间是由服务端生成的，客户端时间跟服务端时间可能存在误差，这就会导致缓存命中的误差；
- 被 Cache-Control 替代

##### Cache-Control

```
Accept: */*
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cache-Control: no-cache
Connection: keep-alive
Content-Length: 7298
Content-Type: text/plain;charset=UTF-8
Host:
Origin: https:
Pragma: no-cache
Referer: https://
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36
x-log-apiversion: 0.6.0
x-log-bodyrawsize: 1234

```

在请求头的里面，Request Headers 有 Cache-Control，里面的一些属性意义如下

public

所有内容都将被缓存(客户端和代理服务器都可缓存)

private

内容只缓存到私有缓存中(仅客户端可以缓存，代理服务器不可缓存)

no-cache

必须先与服务器确认返回的响应是否被更改，然后才能使用该响应来满足后续对同一个网址的请求。因此，如果存在合适的验证令牌 (ETag)，no-cache 会发起往返通信来验证缓存的响应，如果资源未被更改，可以避免下载。

no-store

所有内容都不会被缓存到缓存或 Internet 临时文件中

must-revalidation/proxy-revalidation

如果缓存的内容失效，请求必须发送到服务器/代理以进行重新验证

max-age=xxx

缓存的内容将在 xxx 秒后失效, 这个选项只在 HTTP 1.1 可用, 并如果和 Last-Modified 一起使用时, 优先级较高

#### 协商缓存

（相当于就是浏览器与服务器通过一个值作为更新 flag，一个协商一个判断）
协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程

##### Etag/If-None-Match

当浏览器请求服务器的某项资源（A）时，服务器会根据 A 算出一个哈希值，并通过 Etag 返回给浏览器，浏览器把 ETAG 和资源 A 同时缓存到本地。
当下次向服务器请求该资源时，会通过 If-None-Match 把 ETAG 发送给服务器。
服务器再次计算 A 的哈希值并和浏览器的返回值作比较，如果 A 发生了变化就把 A 返回给浏览器（返回值 200）,如果未发生变化就返回浏览器 304（未修改）

换种理解方式：
如果缓存中有 ETag 令牌，客户端请求时会自动在“If-None-Match” HTTP 请求标头内提供 ETag 令牌。
服务器根据当前资源核对令牌，验证是否发生变化，将验证结果通知给客户端，客户端根据结果看看是否需要从缓存中读取还是发送资源请求。

##### Last-Modified/If-Modified-Since

在浏览器请求服务器的某项资源时，返回资源的同时还有一个 Last-Modified 的属性标记此文件在服务器端的最后修改时间；
浏览器第二次访问该资源时，会向服务器传送 If-Modified-Since 报头，询问该时间之后文件是否被修改过；
如果服务器的资源没有变化，则时间一致，返回 304 的状态吗，浏览器使用本地缓存；
如果时间不一致，返回 200，显示新文件并缓存。

##### 二者区别

Etag 是标识传输，Last-Modified 是时间传输;
Etag 的优先级高于 Last-Modified;
Last-modified 标注的最后修改时间只能精确到秒，如果文件在 1 秒以内被多次修改，它不能准确标注文件的最后修改时间；
如果文件定期生成，但内容没有任何变化，但是 last-modified 却改变了，导致没法使用缓存；
有可能存在服务器没有准确获取文件修改时间，或与代理服务器时间不一致的情况；
etag 每次服务端生成都需要进行读写操作，而 last-modified 只需要读取操作，etag 消耗更大些；

#### 强缓存和协商缓存

强缓存规则：

已失效时，请求服务器，服务器返回数据和缓存规则，客户端将数据和缓存规则存入缓存数据库；
未失效时，请求缓存数据库，返回数据并渲染；
协商缓存规则：

先到缓存数据库中获取标识 Etag/Last-Modified，
再通过 If-None-Match/If-Modified-Since 字段带上缓存标识请求服务器，服务器判断内容是否失效；

顺序：
强缓存未失效，从缓存中读取数据，cache-control 优先级高于 Expires；
强缓存已失效，执行协商缓存，Etag 的优先级高于 last-Modified；
缓存未失效从缓存中读取数据返回 304 状态码；
缓存已失效返回资源和 200 状态码；

### 浏览器缓存

#### 本地小容量缓存

##### Cookie

##### LocalStorage

localStorage.setItem("key",value)
var value=localStorage.getItem("key")
localStorage.removeItem(key);

##### SessionStorage

#### 本地大容量缓存

##### WebSql

用 sql 操作数据库

##### IndexDB

也是数据库

### 应用程序缓存

#### 应用缓存

#### PWA

\*\*

-                             _ooOoo_
-                            o8888888o
-                            88" . "88
-                            (| -_- |)
-                            O\  =  /O
-                         ____/`---'\____
-                       .'  \\|     |//  `.
-                      /  \\|||  :  |||//  \
-                     /  _||||| -:- |||||-  \
-                     |   | \\\  -  /// |   |
-                     | \_|  ''\---/''  |   |
-                     \  .-\__  `-`  ___/-. /
-                   ___`. .'  /--.--\  `. . __
-                ."" '<  `.___\_<|>_/___.'  >'"".
-               | | :  `- \`.;`\ _ /`;.`/ - ` : | |
-               \  \ `-.   \_ __\ /__ _/   .-` /  /
-          ======`-.____`-.___\_____/___.-`____.-'======
-                             `=---='
-          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
-                     佛祖保佑        永无BUG
-            佛曰:
-                   写字楼里写字间，写字间里程序员；
-                   程序人员写程序，又拿程序换酒钱。
-                   酒醒只在网上坐，酒醉还来网下眠；
-                   酒醉酒醒日复日，网上网下年复年。
-                   但愿老死电脑间，不愿鞠躬老板前；
-                   奔驰宝马贵者趣，公交自行程序员。
-                   别人笑我忒疯癫，我笑自己命太贱；
-                   不见满街漂亮妹，哪个归得程序员？
